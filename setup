#!/bin/bash
[ $(id -u) == 0 ] || { echo Please run as root.; exit 1; }
set -x
USERNAME=rap
echo "${USERNAME}" > /etc/username

# Non-root user setup
grep ^${USERNAME}: /etc/passwd || useradd -d /home/${USERNAME} -s /bin/bash ${USERNAME}
echo "${USERNAME} ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/${USERNAME}

# Basic setup
export DEBIAN_FRONTEND=noninteractive
echo 'deb http://deb.debian.org/debian buster-backports main' > /etc/apt/sources.list.d/backports.list
apt update 								&> /tmp/setup-01.log

# Git setup (assuming curl and git are already installed)
git clone https://github.com/rodolfoap/fastup.git /root/fastup
cd /root/fastup
apt -y -t buster-backports full-upgrade 				&> /tmp/setup-02.log
apt -y install -t buster-backports $(grep -v '^#' dat/software.basic)	&> /tmp/setup-03.log

# User setup
mkdir -p /home/${USERNAME}/git/
cp -r /root/fastup /home/${USERNAME}/git/fastup

# Fix .bashrc
./dat/bashrc.fix
chown -R ${USERNAME}: /home/${USERNAME}

echo Done.
